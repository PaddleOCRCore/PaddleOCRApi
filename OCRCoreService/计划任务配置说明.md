# OCRCoreService Windows计划任务配置说明

## 问题描述
当使用Windows计划任务启动OCRCoreService时，可能会出现图像处理错误：
```
[ERROR] Unknown error occurred during image byte processing.
Unexpected character encountered while parsing value: E. Path '', line 1, position 1.
```

## 原因分析
Windows计划任务在非交互式会话（Session 0）中运行时，缺少必要的用户桌面环境和GDI+权限，导致图像处理库无法正常工作。

## 解决方案

### 方案一：使用计划任务（推荐）

#### 1. 创建计划任务
1. 打开"任务计划程序"（taskschd.msc）
2. 点击"创建任务"（不要用"创建基本任务"）

#### 2. 常规选项卡配置
- 名称：`OCRCoreService`
- 描述：`PaddleOCR WebAPI服务`
- 勾选：`不管用户是否登录都要运行`
- 勾选：`使用最高权限运行`
- 配置：Windows 10/Windows Server 2016

#### 3. 触发器选项卡
- 新建触发器
- 开始任务：`启动时`
- 延迟任务时间：`30秒`（等待系统服务启动）
- 勾选：`已启用`

#### 4. 操作选项卡
- 操作：`启动程序`
- 程序或脚本：`StartOCRApi_Scheduled.bat`

#### 5. 条件选项卡
- 取消勾选：`只有在计算机使用交流电源时才启动此任务`
- 勾选：`如果错过计划开始时间，立即启动任务`

#### 6. 设置选项卡
- 勾选：`如果任务失败，重启间隔`：`1分钟`，重试次数：`3`
- 勾选：`如果请求后任务还在运行，强行将其停止`
- 停止任务的运行时间：`3天`

### 方案二：注册为Windows服务

#### 1. 使用NSSM工具
下载NSSM：https://nssm.cc/download

#### 2. 安装服务
```cmd
# 以管理员身份运行CMD
cd "OCRCoreService的目录"

# 安装服务
nssm install OCRCoreService "dotnet.exe" "OCRCoreService.dll --urls http://*:5000"

# 设置工作目录
nssm set OCRCoreService AppDirectory "OCRCoreService的目录"

# 设置环境变量
nssm set OCRCoreService AppEnvironmentExtra DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=0

# 设置为自动启动
nssm set OCRCoreService Start SERVICE_AUTO_START

# 启动服务
nssm start OCRCoreService
```

#### 3. 管理服务
```cmd
# 停止服务
nssm stop OCRCoreService

# 重启服务
nssm restart OCRCoreService

# 查看状态
nssm status OCRCoreService

# 卸载服务
nssm remove OCRCoreService confirm
```

### 方案三：使用sc命令注册服务

```cmd
# 以管理员身份运行CMD
sc create OCRCoreService binPath="dotnet.exe OCRCoreService的目录\OCRCoreService.dll --urls http://*:5000" start=auto

# 启动服务
sc start OCRCoreService

# 停止服务
sc stop OCRCoreService

# 删除服务
sc delete OCRCoreService
```

## 批处理文件说明

### StartOCRApi.bat
手动启动脚本，用于交互式启动，适合开发调试。

### StartOCRApi_Scheduled.bat
计划任务启动脚本，专门用于Windows计划任务，包含：
- UTF-8编码支持
- 环境变量设置
- 日志记录
- 后台运行
- 启动状态检查

### StopOCRApi.bat
停止服务脚本，可手动执行停止服务。

## 日志文件位置

- 启动日志：`logs\service_startup.log`
- 服务输出日志：`logs\service_output.log`
- NLog日志：按nLog.config配置

## 验证服务运行

### 1. 检查进程
```powershell
Get-Process -Name dotnet | Where-Object {$_.MainWindowTitle -like "*OCRCoreService*"}
```

### 2. 测试API
浏览器访问：http://localhost:5000

### 3. 查看Swagger
http://localhost:5000/swagger/index.html

### 4. 查看日志
```powershell
Get-Content "OCRCoreService的目录\logs\service_startup.log" -Tail 20
```

## 故障排查

### 1. 服务无法启动
- 检查.NET 8.0运行时是否已安装
- 检查端口5000是否被占用：`netstat -ano | findstr :5000`
- 查看启动日志：`logs\service_startup.log`

### 2. API调用错误
- 确认计划任务配置了"使用最高权限运行"
- 检查是否设置了环境变量`DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=0`
- 查看服务输出日志：`logs\service_output.log`

### 3. 图像处理失败
- 确保计划任务配置为"不管用户是否登录都要运行"
- 建议使用方案二（NSSM）注册为Windows服务

## 性能优化建议

1. **内存限制**：在appsettings.json中配置cpu_mem参数
2. **线程数**：根据CPU核心数调整cpu_math_library_num_threads
3. **GPU加速**：如有GPU，配置use_gpu=true

## 安全建议

1. 修改默认端口5000为其他端口
2. 配置防火墙规则限制访问IP
3. 启用HTTPS（需要配置SSL证书）
4. 实施API密钥验证

## 联系支持

- QQ群：475159576
- 定制开发QQ：2380243976
- GitHub：https://github.com/PaddleOCRCore/PaddleOCRApi
